---
title: "HW4"
author: "Marco Navarro, Asha Christensen, Pranjal Maheshka"
date: "2023-04-17"
output: md_document
always_allow_html: true
---

# DataMining_PS4

## Pranjal Maheshka, Asha Christensen, Marco Navarro
### 2023-04-17

## Question 2 Market segmentation

```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ClusterR)  # for kmeans++
library(foreach)
library(mosaic)
library(cowplot)

library(igraph)
library(arules)  # has a big ecosystem of packages built around it
library(arulesViz)
```

In order to carry out this market segmentation exercise for NutrientH20, we used tweets from followers of the Twitter account of the brand. Each tweet was categorized based on its content using a pre-specified scheme of 36 different categories, each representing a broad area of interest (e.g. politics, sports, family, etc.).

First of all, we eliminate some categories of the data base that do not add interesting information, such as "spam", "adult" and "chatter". Then, we calculate the ratio between the number of posts by a given user that fell into the given category and the total number annotations for each user before centering and scaling the data.

```{r , include=FALSE}
################################### Read dataset
social = read.csv("social_marketing.csv")

social2 = social[,-c(1,2,36,37)]

Z = social2/rowSums(social2)

#social2 = social2 %>%
#  mutate(total = rowSums(social2))

ZZ = scale(Z, center=TRUE, scale=TRUE)

```

For the market segmentation we try to divide followers (probably costumers) into different groups according to similarities in their tweets categories. Once we have identified these groups, the company will have more knowledge about their followers (costumers) and design marketing strategies accordingly.

In order to separate followers in distinct groups, we use a popular unsupervised learning method known as K-means++. As a result of this process, we divide followers in 5 different clusters, and accounts whose tweets are classified to the same or similar categories end up in the same group, cluster or market segment. The elbow plot suggests more clusters, but we pick 5 in order to facilitate the interpretation of our results.

```{r , include=FALSE}
k_grid = seq(2, 30, by=1)
SSE_grid = foreach(k = k_grid, .combine='c') %do% {
cluster_k = kmeans(ZZ, k, nstart=50)
cluster_k$tot.withinss
}

plot(SSE_grid)
```

```{r , include=FALSE}
clust1 = KMeans_rcpp(ZZ, 5)
```

Once we have identified these 5 clusters, we need to associate each cluster to a category or set of categories in order to provide more useful information. To accomplish that, we perform a principal component analysis in order to know which principal component is more related to each cluster and then analyze the loadings principal components.

In the following graphs, we can visualize relationships between each cluster and the principal components. These relationships and the loadings of the principal components can be used to identify relevant categories for each cluster.

```{r , include=FALSE}
pc_Z = prcomp(ZZ, rank=10)

summary(pc_Z)

scores = as.data.frame(pc_Z$x)

loadings= pc_Z$rotation %>%
  as.data.frame() %>%
  rownames_to_column('Category')

loadings %>%
  select(Category, PC1) %>%
  arrange(desc(PC1))

Social3 =  cbind(ZZ,scores)
```

```{r , echo=FALSE}
## cluster  2 3 and 4 pc2
A= ggplot(Social3) + 
  geom_point(aes(PC2, PC1, color=factor(clust1$cluster)))+
  theme(legend.position = "none")

## cluster 1 and 5 pc3
B =ggplot(Social3) + 
  geom_point(aes(PC3, PC1, color=factor(clust1$cluster)))+
  theme(legend.position = "none")

## cluster 3 pc4
C =ggplot(Social3) + 
  geom_point(aes(PC5, PC4, color=factor(clust1$cluster)))+
  guides(color = guide_legend(title = "Clusters"))

library("cowplot")
ggdraw() +
  draw_plot(A, x = 0, y = .5, width = .5, height = .5) +
  draw_plot(B, x = .5, y = .5, width = .5, height = .5) +
  draw_plot(C, x = 0, y = 0, width = .6, height = 0.5)
```

|Category |Loadings PC1| Category |Loadings PC2| Category |Loadings PC3|Category |Loadings PC4|Category |Loadings PC5|    
| ----- |:---:|  ----- |:---:|  ----- |:---:| ----- |:---:| ----- |:---:|
|sports_fandom | 0.404690305|politics|0.261102608|politics|0.357194859|fashion|0.2486018310|fashion|0.286886643|
|religion | 0.400669823	|travel|0.236649408|news|0.329012235|beauty|0.2366545788|cooking|0.27238276|
|parenting | 0.378260522|	college_uni	|	0.203784704|health_nutrition|0.278810631|cooking|0.2320392878|beauty|0.261100664|
|food | 0.285342668	|	tv_film|0.174483882|personal_fitness|0.265768747|politics|0.2253890276|news|0.252758649|
|school | 0.254633402|	current_events|	0.153131682	|outdoors|0.264414042|photo_sharing|0.1936194074|online_gaming|0.246631776|
|.|	.|.|.|.|.|.|.|.|.|
|outdoors | -0.144632427|cooking|	-0.20634821|school|-0.155270893|food|-0.1071448600|crafts|-0.150803291|
|fashion|-0.183544726|food			|-0.231026889|photo_sharing|-0.224246899|tv_film|	-0.151685085|eco|-0.219445309|
|personal_fitness | -0.225382342|	outdoors|	-0.272709650	|	cooking|-0.243277175|sports_playing|-0.2903722124|current_events|-0.262704701|
|health_nutrition |-0.243124199		|personal_fitness|-0.381209631|beauty|-0.321209763|online_gaming|-0.4735595614|photo_sharing|-0.308125501|
|cooking| -0.275127013|health_nutrition|-0.404175549|fashion|-0.339373781|college_uni|-0.4931870468|shopping|-0.394375778|



The first cluster is associated with positive values of the second and third principal component (PC2 and PC3). Taking that information into account and looking at the loadings, we can conclude that important categories of this cluster are politics, travel, college_uni, tv_film, current_events, news, health_nutrition and personal_fitness. Consequently, this market segment includes young adults who are probably in college and are  political enthusiasts. They also have a healthy lifestyle and are also well aware of the current social and political problems.

The second cluster is associated with positive values of PC2 and negative values of PC5. In this cluster, the important categories are politics, travel, college_uni, tv_film, current_events, news, shopping, photo_sharing and eco. It is similar to the firs group (college students and interested in politics and current events), but they are probably also interested in spending their free time shopping, creating social media content instead of doing physical activities. 

The third cluster is associated with positive values of PC2 and PC5. For this cluster, important categories are politics, travel, college_uni,tv_film, current_events, news, fashion, cooking and beauty. Again, this group includes young adults in college, and they care about their appearance and political events. 

The fourth cluster is associated with negative values of PC2. The most important categories with negative loadings in this component are health_nutrition, personal_fitness, outdoors and cooking. So, we can conclude that one of the market segments is composed by people with an active and healthy lifestyle who spend a considerable part of their free time doing physical activities, and also cares about the type of food they consume.

The last cluster is associated to negative values of PC3. Categories with the lowest negative loadings in PC3 are fashion, beauty, cooking, photo_sharing, school and religion. As a result, we can conclude that one of the market segments includes adults with kids who spend a considerable amount of time sharing content on social media. In addition, they care about religion and are concerned about their own appearance.

The information about the clusters can provide a better understanding of the groups of costumers or potential ones, so the company is in a better position to successfully design marketing campaigns for these different groups.

## Question 3: Association rules for grocery purchases


```{r, echo=FALSE, warning=FALSE}

groceries = read.table('groceries.txt', header=FALSE, sep = "\n", fill=TRUE)

groceries = separate(groceries, V1, c("1", "2", "3", "4", "5","6","7","8","9","10", "11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32"), sep = ",")


#shopper 1 to start us off
grocerydf = as.data.frame(t(groceries[1, 1:32]))
grocerydf = na.omit(grocerydf)
grocerydf$shopper = 1
grocerydf = grocerydf %>%
  rename("good" = "1")

for (i in 2:length(groceries$"1")) {
tempdf = as.data.frame(t(groceries[i, 1:32]))
tempdf = na.omit(tempdf)
tempdf$shopper = i
tempdf = tempdf %>%
  rename("good" = toString(i))
grocerydf = rbind(grocerydf, tempdf)
}

grocerydf$shopper = factor(grocerydf$shopper)
grocerydf = split(x=grocerydf$good, f=grocerydf$shopper)


```

```{r, echo=FALSE, include=FALSE}
grocerydf = lapply(grocerydf, unique)

grocerytrans = as(grocerydf, "transactions")
summary(grocerytrans)

```

```{r, echo=FALSE, include=FALSE}

groceryrules2 = apriori(grocerytrans, parameter=list(support=.01, confidence=.5, maxlen=4))
groceryrules1 = apriori(grocerytrans, parameter=list(support=.005, confidence=.05, maxlen=4))
```

First, let's create a very broad associations model by using thresholds that are very low (support = 0.005, confidence = 0.05). We allow up to 4 goods to be correlated: 

```{r, echo=FALSE, warning=FALSE, message=FALSE}
plot(groceryrules1)

# can swap the axes and color scales
plot(groceryrules1, measure = c("support", "lift"), shading = "confidence")

# "two key" plot: coloring is by size (order) of item set
plot(groceryrules1, method='two-key plot')

# graph-based visualization
# export
# associations are represented as edges
# For rules, each item in the LHS is connected
# with a directed edge to the item in the RHS. 

```
```{r, echo = FALSE}

subrules = head(groceryrules1, n=10, by="lift")
plot(subrules, method = "graph", engine = "htmlwidget")
plot(subrules, method="paracoord")

```

Here we can see strong 2-way rule associations: ham and white bread, tropical fruit and whole milk, butter and whipped cream, etc. However, it may be the case that whole milk and tropical fruit are just 2 of the most common items, meaning that we are not really capturing an association, but rather just a result of this dual commonality, as seen below.

```{r, ehco=FALSE}
itemFrequencyPlot(grocerytrans, topN=10,  cex.names=1)

```

If we are using this data analysis for a practical purpose, such as marketing, then we will want these rules to be relevant to a larger number of individuals and more true for those individuals. This means that we should set our confidence and support higher: I don't care about rules which impact less than 1% of consumers, and I don't care about rules which are true less than 50% of the time. Therefore, we can rerun the apriori function with support = 0.01 and confidence = 0.5:

```{r, echo=FALSE, warning=FALSE}
plot(groceryrules2)

# can swap the axes and color scales
plot(groceryrules2, measure = c("support", "lift"), shading = "confidence")

# "two key" plot: coloring is by size (order) of item set
plot(groceryrules2, method='two-key plot')

# graph-based visualization
# export
# associations are represented as edges
# For rules, each item in the LHS is connected
# with a directed edge to the item in the RHS. 

```
We do have much less rules, however, the rules that remain are applicable to a larger portion of shoppers and are more strongly true, and are therefore more relevant to application

```{r, ehco=FALSE}

subrules = head(groceryrules2, n=10, by="lift")
plot(subrules, method = "graph", engine = "htmlwidget")
plot(subrules, method="paracoord")

```
